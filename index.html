<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkySentry | Command Console</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f172a;
            --neon: #39ff14;
            --alert: #ff3333;
            --glass: rgba(15, 23, 42, 0.95);
            --border: #334155;
        }

        body { margin: 0; background: var(--bg-color); color: white; font-family: 'JetBrains Mono', monospace; overflow: hidden; }

        /* --- THE FIX: FORCE TRANSPARENT ICONS --- */
        /* This forces Leaflet not to draw white boxes around our custom SVGs */
        .leaflet-div-icon {
            background: transparent !important;
            border: none !important;
        }

        /* --- LAYOUT LAYERS --- */
        #map { position: absolute; inset: 0; z-index: 1; background: #0f172a; }
        .grid { position: absolute; inset: 0; z-index: 2; pointer-events: none; 
                background-image: linear-gradient(rgba(57, 255, 20, 0.1) 1px, transparent 1px),
                                  linear-gradient(90deg, rgba(57, 255, 20, 0.1) 1px, transparent 1px);
                background-size: 50px 50px; }
        
        /* --- SIDEBAR --- */
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 80px; background: var(--glass); 
                   border-right: 1px solid var(--border); z-index: 100; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        
        .btn { background: none; border: none; color: #64748b; padding: 15px; cursor: pointer; transition: 0.2s; }
        .btn:hover { color: white; }
        .btn.active { color: var(--neon); text-shadow: 0 0 10px var(--neon); }

        /* --- UI OVERLAY --- */
        .ui { position: absolute; top: 0; left: 80px; right: 0; bottom: 0; z-index: 50; pointer-events: none; padding: 20px; }
        
        .panel { background: var(--glass); border: 1px solid var(--border); padding: 15px; border-radius: 4px; pointer-events: auto; }
        .top-bar { display: flex; justify-content: space-between; }
        .bottom-bar { display: flex; justify-content: space-between; position: absolute; bottom: 20px; left: 100px; right: 20px; }

        h1 { margin: 0; font-size: 20px; color: var(--neon); }
        .status-box { background: rgba(255, 51, 51, 0.1); border: 1px solid var(--alert); color: var(--alert); padding: 10px; font-weight: bold; animation: pulse 2s infinite; }
        .status-box.safe { border-color: var(--neon); color: var(--neon); background: rgba(57, 255, 20, 0.1); animation: none; }

        /* --- SETTINGS PANEL (Hidden by default) --- */
        #settings {
            display: none; position: absolute; top: 80px; left: 90px; width: 300px; 
            background: #1e293b; border: 1px solid var(--neon); padding: 20px; z-index: 200;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .setting-row { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        input { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 5px; font-family: inherit; }
        
        .mode-switch { display: flex; gap: 10px; margin-top: 10px; }
        .mode-btn { flex: 1; padding: 8px; border: 1px solid #334155; background: #0f172a; color: #64748b; cursor: pointer; font-size: 12px; }
        .mode-btn.selected { background: var(--neon); color: black; font-weight: bold; }
        .mode-btn.attack { background: #0f172a; border-color: var(--alert); color: var(--alert); }
        .mode-btn.attack.selected { background: var(--alert); color: white; }

        /* --- ANIMATIONS --- */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="grid"></div>

    <div class="sidebar">
        <div style="color:var(--neon); margin-bottom:30px;">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>
        <button class="btn active" onclick="toggleSettings(false)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></button>
        <button class="btn" onclick="toggleSettings(true)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
    </div>

    <div class="ui">
        <div class="top-bar">
            <div class="panel">
                <h1>PROJECT: SKYSENTRY</h1>
                <div style="font-size:10px; color:#94a3b8;">STATUS: CLASSIFIED</div>
            </div>
            <div id="status-display" class="panel status-box">
                ‚ö† THREAT DETECTED: SECTOR 7
            </div>
        </div>
        
        <div class="bottom-bar">
            <div class="panel" style="border-left: 3px solid var(--neon);">
                <div id="coords-display">LAT: 34.55 N <br> LNG: 77.12 E</div>
                <strong style="color:var(--neon); font-size:12px;">UAV LINK: ACTIVE</strong>
            </div>
        </div>
    </div>

    <div id="settings">
        <h3 style="margin-top:0; color:var(--neon);">COMMAND SETTINGS</h3>
        
        <div class="setting-row">
            <label>TARGET COORDINATES (Click Map to Set)</label>
            <div style="display:flex; gap:5px;">
                <input id="input-lat" type="text" value="15.00">
                <input id="input-lng" type="text" value="85.00">
            </div>
        </div>

        <div class="setting-row">
            <label>ENGAGEMENT MODE</label>
            <div class="mode-switch">
                <button id="btn-defend" class="mode-btn selected" onclick="setMode('defend')">üõ°Ô∏è DEFENSIVE</button>
                <button id="btn-attack" class="mode-btn attack" onclick="setMode('attack')">üöÄ ATTACK</button>
            </div>
            <p style="font-size:10px; color:#64748b; margin-top:5px;">
                *Defensive: Escort/Orbit<br>*Attack: Destroy on Contact
            </p>
        </div>
        <button onclick="toggleSettings(false)" style="width:100%; padding:5px; background:var(--border); color:white; border:none; cursor:pointer;">CLOSE CONSOLE</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. CONFIG & STATE ---
        let map;
        let targetMarker;
        let jets = [];
        let animationFrame;
        
        // State
        let targetLoc = [20.59, 78.96]; // Center of India
        let currentMode = 'defend'; // 'defend' or 'attack'
        let isTargetDestroyed = false;

        // --- 2. INITIALIZATION ---
        function init() {
            // Setup Map
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(targetLoc, 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

            // Add Click Listener (To move target)
            map.on('click', function(e) {
                if(isTargetDestroyed) return; // Can't move destroyed target
                updateTarget(e.latlng.lat, e.latlng.lng);
            });

            // Icons
            const threatIcon = L.divIcon({
                // NOTE: className is NOT used here, we fix it in CSS at the top
                html: `<div style="color:#ff3333;"><svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>`,
                iconSize: [30,30], iconAnchor: [15,15]
            });

            // Create Target
            targetMarker = L.marker(targetLoc, {icon: threatIcon}).addTo(map).bindPopup("TARGET").openPopup();

            // Create Jets (Start at bases)
            const bases = [
                { lat: 28.61, lng: 77.20 }, // Delhi
                { lat: 19.07, lng: 72.87 }, // Mumbai
                { lat: 12.97, lng: 77.59 }  // Bangalore
            ];

            bases.forEach(base => {
                let marker = L.marker([base.lat, base.lng], { icon: createJetIcon(0) }).addTo(map);
                jets.push({ lat: base.lat, lng: base.lng, marker: marker, speed: 0.05 + Math.random() * 0.05 }); // Random speeds
            });

            // Start Loop
            animate();
        }

        // --- 3. HELPER FUNCTIONS ---
        function createJetIcon(rot) {
            return L.divIcon({
                 // NOTE: className is NOT used here, we fix it in CSS at the top
                html: `<div style="color:#39ff14; transform:rotate(${rot}deg); transition: transform 0.1s;">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>
                       </div>`,
                iconSize: [30,30], iconAnchor: [15,15]
            });
        }

        function updateTarget(lat, lng) {
            targetLoc = [lat, lng];
            targetMarker.setLatLng(targetLoc);
            // Update inputs
            document.getElementById('input-lat').value = lat.toFixed(4);
            document.getElementById('input-lng').value = lng.toFixed(4);
            
            // Reset destroyed status if moved
            if(isTargetDestroyed) {
                isTargetDestroyed = false;
                document.getElementById('status-display').innerHTML = "‚ö† THREAT DETECTED";
                document.getElementById('status-display').className = "panel status-box";
                targetMarker.setOpacity(1);
            }
        }

        function toggleSettings(show) {
            document.getElementById('settings').style.display = show ? 'block' : 'none';
        }

        function setMode(mode) {
            currentMode = mode;
            // Update Buttons UI
            document.getElementById('btn-defend').className = mode === 'defend' ? 'mode-btn selected' : 'mode-btn';
            document.getElementById('btn-attack').className = mode === 'attack' ? 'mode-btn attack selected' : 'mode-btn attack';
        }

        // --- 4. ANIMATION LOOP ---
        function animate() {
            if (!isTargetDestroyed) {
                jets.forEach(jet => {
                    // Distance to target
                    let dy = targetLoc[0] - jet.lat;
                    let dx = targetLoc[1] - jet.lng;
                    let distance = Math.sqrt(dy*dy + dx*dx);

                    // LOGIC: DEFENSIVE VS ATTACK
                    let speed = 0.02; // Base Speed

                    if (currentMode === 'defend') {
                        // If defensive, stop at distance 1.0 (Orbit)
                        if (distance > 1.0) {
                            jet.lat += dy * 0.01;
                            jet.lng += dx * 0.01;
                        } else {
                            // Orbit logic (simple jitter for now)
                            jet.lat += (Math.random() - 0.5) * 0.05;
                            jet.lng += (Math.random() - 0.5) * 0.05;
                        }
                    } 
                    else if (currentMode === 'attack') {
                        // Fly straight in
                        jet.lat += dy * 0.02;
                        jet.lng += dx * 0.02;

                        // COLLISION DETECTION
                        if (distance < 0.2) {
                            destroyTarget();
                        }
                    }

                    // Rotation
                    let angle = Math.atan2(dx, dy) * 180 / Math.PI;
                    jet.marker.setLatLng([jet.lat, jet.lng]);
                    jet.marker.setIcon(createJetIcon(angle));
                });
            }
            requestAnimationFrame(animate);
        }

        function destroyTarget() {
            if(isTargetDestroyed) return;
            isTargetDestroyed = true;
            
            // Visual Effect
            targetMarker.bindPopup("<b>üí• DESTROYED üí•</b>").openPopup();
            
            // UI Update
            const statusBox = document.getElementById('status-display');
            statusBox.innerHTML = "üéØ TARGET ELIMINATED";
            statusBox.className = "panel status-box safe"; // Turns green
            
            // Slight delay then hide target
            setTimeout(() => { targetMarker.setOpacity(0.5); }, 500);
        }

        // Run
        init();
    </script>
</body>
</html>